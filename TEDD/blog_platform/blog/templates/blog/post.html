<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{{ post.title }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <nav class="navbar navbar-dark bg-black p-3 d-flex justify-content-between">
        <a class="navbar-brand text-white" href="/">TEDD</a>
        {% if user.is_authenticated %}
            <div class="d-flex align-items-center">
                <button class="btn btn-light mx-2" onclick="openCreatePostModal()">–ù–∞–ø–∏—Å–∞—Ç—å</button>
                <button class="btn btn-light mx-2" onclick="location.href='{% url 'messages' %}'">–°–æ–æ–±—â–µ–Ω–∏—è</button>
                <a href="{% url 'profile' user.username %}" class="rounded-circle bg-light p-2">
                    <img src="{{ user.profile.avatar.url }}" alt="–ê–≤–∞—Ç–∞—Ä" class="avatar header-avatar" onerror="this.onerror=null; this.src='/static/icons/default_avatar.jpg';">
                </a>
            </div>
        {% else %}
            <div>
                <button class="btn btn-light mx-1" onclick="location.href='{% url 'login' %}'">–í–æ–π—Ç–∏</button>
                <button class="btn btn-outline-light mx-1" onclick="location.href='{% url 'register' %}'">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>
        {% endif %}
    </nav>

    <div class="container mt-4">
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <img src="{{ post.author.profile.avatar.url }}" alt="–ê–≤–∞—Ç–∞—Ä" class="post-avatar" onerror="this.onerror=null; this.src='/static/icons/default_avatar.jpg';">
                        <a href="{% url 'profile' post.author.username %}" class="text-dark"><strong>{{ post.author.username }}</strong></a>
                    </div>
                </div>
                <h3>{{ post.title }}</h3>
                <p class="mt-2">{{ post.content }}</p>
                {% if post.image %}
                <img src="{{ post.image.url }}" class="img-fluid">
                {% endif %}
                <div class="d-flex justify-content-between mt-2">
                    <button class="btn btn-light" onclick="toggleComments({{ post.id }})">üí¨ <span id="comment-count-{{ post.id }}">{{ post.comments.count }}</span></button>
                    <div>
                        <button class="btn btn-light" onclick="likePost({{ post.id }})">üëç <span id="like-count-{{ post.id }}">{{ post.total_likes }}</span></button>
                        <button class="btn btn-light" onclick="dislikePost({{ post.id }})">üëé <span id="dislike-count-{{ post.id }}">{{ post.total_dislikes }}</span></button>

                    </div>

                </div>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
        <div id="comments-section-{{ post.id }}" class="d-none">
            <h5><span id="comment-header-{{ post.id }}">{{ post.comments.count }}</span> –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</h5>

            <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
            <textarea id="comment-input-{{ post.id }}" class="form-control my-2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
            <button class="btn btn-dark" onclick="addComment({{ post.id }})">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

            <div id="comments-list-{{ post.id }}">
                {% for comment in post.comments.all %}
                <div class="card mt-2 p-2">
                    <div class="d-flex align-items-center">
                        <img src="{{ comment.author.profile.avatar.url }}" class="rounded-circle me-2" onerror="this.onerror=null; this.src='/static/icons/default_avatar.jpg';">
                        <a href="{% url 'profile' comment.author.username %}" class="text-dark"><strong>{{ comment.author.username }}</strong></a>
                    </div>
                    <p class="mt-1">{{ comment.content }}</p>
                    <button class="btn btn-sm btn-light" onclick="replyToComment({{ post.id }}, {{ comment.id }})">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                    <div id="replies-{{ comment.id }}" class="d-none"></div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        function toggleComments(postId) {
            let commentsSection = document.getElementById(`comments-section-${postId}`);

            // –ï—Å–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç—ã ‚Äì —Å–∫—Ä—ã–≤–∞–µ–º –∏—Ö
            if (!commentsSection.classList.contains("d-none")) {
                commentsSection.classList.add("d-none");
                return;
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–∑ API
            fetch(`/post/${postId}/comments/`)
                .then(response => response.json())
                .then(data => {
                    let commentList = document.getElementById(`comments-list-${postId}`);
                    commentList.innerHTML = "";  // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π –Ω–æ–≤—ã—Ö

                    data.comments.forEach(comment => {
                        let newComment = `
                            <div class="card mt-2 p-2">
                                <div class="d-flex align-items-center">
                                    <img src="${comment.avatar}" class="rounded-circle me-2" width="30">
                                    <a href="/profile/${comment.author}" class="text-dark"><strong>${comment.author}</strong></a>
                                </div>
                                <p class="mt-1">${comment.content}</p>
                                <button class="btn btn-sm btn-light" onclick="replyToComment(${postId}, ${comment.comment_id})">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                                <div id="replies-${comment.comment_id}" class="d-none"></div>
                            </div>
                        `;
                        commentList.insertAdjacentHTML("beforeend", newComment);
                    });

                    commentsSection.classList.remove("d-none"); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                })
                .catch(error => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:", error));
        }

        function addComment(postId) {
            let content = document.getElementById(`comment-input-${postId}`).value;
            let formData = new FormData();
            formData.append("content", content);

            fetch(`/post/${postId}/comment/`, {
                method: "POST",
                body: formData,
                headers: { "X-CSRFToken": document.querySelector("input[name=csrfmiddlewaretoken]").value }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let commentList = document.getElementById(`comments-list-${postId}`);
                    let newComment = `
                        <div class="card mt-2 p-2">
                            <div class="d-flex align-items-center">
                                <img src="${data.avatar}" class="rounded-circle me-2" onerror="this.onerror=null; this.src='/static/icons/default_avatar.jpg';">
                                <a href="/profile/${data.author}" class="text-dark"><strong>${data.author}</strong></a>
                            </div>
                            <p class="mt-1">${data.content}</p>
                            <button class="btn btn-sm btn-light" onclick="replyToComment(${postId}, ${data.comment_id})">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                            <div id="replies-${data.comment_id}" class="d-none"></div>
                        </div>
                    `;
                    commentList.insertAdjacentHTML("beforeend", newComment);
                    document.getElementById(`comment-input-${postId}`).value = "";
                    document.getElementById(`comment-count-${postId}`).innerText++;
                }
            });
        }
        function likePost(postId) {
            fetch(`/post/${postId}/like/`, { method: "POST", headers: { "X-CSRFToken": document.querySelector("input[name=csrfmiddlewaretoken]").value } })
            .then(response => response.json())
            .then(data => {
                document.getElementById(`like-count-${postId}`).innerText = data.likes;
                document.getElementById(`dislike-count-${postId}`).innerText = data.dislikes;
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–∞–π–∫–µ:", error));
        }

        function dislikePost(postId) {
            fetch(`/post/${postId}/dislike/`, { method: "POST", headers: { "X-CSRFToken": document.querySelector("input[name=csrfmiddlewaretoken]").value } })
            .then(response => response.json())
            .then(data => {
                document.getElementById(`like-count-${postId}`).innerText = data.likes;
                document.getElementById(`dislike-count-${postId}`).innerText = data.dislikes;
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–∏–∑–ª–∞–π–∫–µ:", error));
}

    </script>
</body>
</html>
