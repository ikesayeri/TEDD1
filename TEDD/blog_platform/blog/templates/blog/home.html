<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>TEDD - –ì–ª–∞–≤–Ω–∞—è</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <script>
        function openCreatePostModal() {
            document.getElementById("createPostModal").classList.remove("d-none");
        }

        function closeCreatePostModal() {
            document.getElementById("createPostModal").classList.add("d-none");
        }

        function submitPost(event) {
            event.preventDefault();
            let formData = new FormData(document.getElementById("postForm"));

            fetch("{% url 'create_post' %}", {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": document.querySelector("input[name=csrfmiddlewaretoken]").value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let postList = document.getElementById("postList");
                    let newPost = `
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <img src="${data.avatar}" class="post-avatar rounded-circle me-2" onerror="this.onerror=null; this.src='/static/icons/default_avatar.jpg';">
                                        <a href="/profile/${data.author}" class="text-dark"><strong>${data.author}</strong></a>
                                    </div>
                                </div>
                                <h5>${data.title}</h5>
                                <p>${data.content}</p>
                                ${data.image ? `<img src="${data.image}" class="img-fluid">` : ''}
                                <div class="d-flex justify-content-between mt-2">
                                    <span>üí¨ 0</span>
                                    <span>üëç 0</span>
                                </div>
                            </div>
                        </div>
                    `;

                    if (postList) {
                        postList.insertAdjacentHTML("afterbegin", newPost);
                    }

                    let profilePostList = document.getElementById("profilePostList");
                    if (profilePostList) {
                        profilePostList.insertAdjacentHTML("afterbegin", newPost);
                    }

                    closeCreatePostModal();
                } else {
                    console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞:", data.error);
                }
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", error));
        }
        function toggleComments(postId) {
            let commentsSection = document.getElementById(`comments-section-${postId}`);

            // –ï—Å–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç—ã ‚Äì —Å–∫—Ä—ã–≤–∞–µ–º –∏—Ö
            if (!commentsSection.classList.contains("d-none")) {
                commentsSection.classList.add("d-none");
                return;
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–∑ API
            fetch(`/post/${postId}/comments/`)
                .then(response => response.json())
                .then(data => {
                    let commentList = document.getElementById(`comments-list-${postId}`);
                    commentList.innerHTML = "";  // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π –Ω–æ–≤—ã—Ö

                    data.comments.forEach(comment => {
                        let newComment = `
                            <div class="card mt-2 p-2">
                                <div class="d-flex align-items-center">
                                    <img src="${comment.avatar}" class="avatar comment-avatar rounded-circle me-2" onerror="this.onerror=null; this.src='/static/icons/default_avatar.jpg';">
                                    <a href="/profile/${comment.author}" class="text-dark"><strong>${comment.author}</strong></a>
                                </div>
                                <p class="mt-1">${comment.content}</p>
                            </div>
                        `;
                        commentList.insertAdjacentHTML("beforeend", newComment);
                    });

                    commentsSection.classList.remove("d-none"); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                })
                .catch(error => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:", error));
        }

        function addComment(postId) {
            let content = document.getElementById(`comment-input-${postId}`).value;
            if (!content.trim()) return;

            let formData = new FormData();
            formData.append("content", content);

            fetch(`/post/${postId}/comment/`, {
                method: "POST",
                body: formData,
                headers: { "X-CSRFToken": document.querySelector("input[name=csrfmiddlewaretoken]").value }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let commentList = document.getElementById(`comments-list-${postId}`);
                    let newComment = `
                        <div class="card mt-2 p-2">
                            <div class="d-flex align-items-center">
                                <img src="${data.avatar}" class="post-avatar rounded-circle me-2" onerror="this.onerror=null; this.src='/static/icons/default_avatar.jpg';">
                                <a href="/profile/${data.author}" class="text-dark"><strong>${data.author}</strong></a>
                            </div>
                            <p class="mt-1">${data.content}</p>
                        </div>
                    `;
                    commentList.insertAdjacentHTML("beforeend", newComment);
                    document.getElementById(`comment-input-${postId}`).value = "";

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                    let countSpan = document.getElementById(`comment-count-${postId}`);
                    countSpan.innerText = parseInt(countSpan.innerText) + 1;
                }
            });
        }
        function likePost(postId) {
            fetch(`/post/${postId}/like/`, { method: "POST", headers: { "X-CSRFToken": document.querySelector("input[name=csrfmiddlewaretoken]").value } })
            .then(response => response.json())
            .then(data => {
                document.getElementById(`like-count-${postId}`).innerText = data.likes;
                document.getElementById(`dislike-count-${postId}`).innerText = data.dislikes;
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–∞–π–∫–µ:", error));
        }

        function dislikePost(postId) {
            fetch(`/post/${postId}/dislike/`, { method: "POST", headers: { "X-CSRFToken": document.querySelector("input[name=csrfmiddlewaretoken]").value } })
            .then(response => response.json())
            .then(data => {
                document.getElementById(`like-count-${postId}`).innerText = data.likes;
                document.getElementById(`dislike-count-${postId}`).innerText = data.dislikes;
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–∏–∑–ª–∞–π–∫–µ:", error));
        }




    </script>
</head>
<body>
    <nav class="navbar navbar-dark bg-black p-3 d-flex justify-content-between">
        <a class="navbar-brand text-white" href="/">TEDD</a>

            <form action="{% url 'search' %}" method="GET" class="d-flex">
                <input class="form-control me-2" type="search" name="q" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ø–æ—Å—Ç–æ–≤" aria-label="Search">
                <button class="btn btn-outline-light" type="submit">üîç</button>
            </form>

        {% if user.is_authenticated %}
            <div class="d-flex align-items-center">
                <button class="btn btn-light mx-2" onclick="openCreatePostModal()">–ù–∞–ø–∏—Å–∞—Ç—å</button>
                <button class="btn btn-light mx-2" onclick="location.href='{% url 'messages' %}'">–°–æ–æ–±—â–µ–Ω–∏—è</button>
                <a href="{% url 'profile' user.username %}" class="rounded-circle bg-light p-2">
                    <img src="{{ user.profile.avatar.url }}" alt="–ê–≤–∞—Ç–∞—Ä" class="avatar header-avatar" onerror="this.onerror=null; this.src='/static/icons/default_avatar.jpg';">
                </a>
            </div>
        {% else %}
            <div>
                <button class="btn btn-light mx-1" onclick="location.href='{% url 'login' %}'">–í–æ–π—Ç–∏</button>
                <button class="btn btn-outline-light mx-1" onclick="location.href='{% url 'register' %}'">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>
        {% endif %}
    </nav>


    <div class="container mt-4">

        <div id="postList">
            {% for post in posts %}
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <img src="{{ post.author.profile.avatar.url }}" class="rounded-circle me-2" width="40">
                            <a href="{% url 'profile' post.author.username %}" class="text-dark"><strong>{{ post.author.username }}</strong></a>
                        </div>
                        {% if post.author != request.user %}
                        <button id="follow-btn-{{ post.author.username }}"
                                class="btn {% if request.user in post.author.profile.followers.all %}btn-outline-dark{% else %}btn-dark{% endif %}"
                                onclick="toggleFollow('{{ post.author.username }}')">
                            {% if request.user in post.author.profile.followers.all %}–ü–æ–¥–ø–∏—Å–∞–Ω–æ{% else %}–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è{% endif %}
                        </button>
                        {% endif %}
                    </div>

                    <h5>{{ post.title }}</h5>
                    <p>{{ post.content|truncatewords:20 }}</p> <!-- –û–±—Ä–µ–∑–∞–µ–º —Ç–µ–∫—Å—Ç -->

                    {% if post.image %}
                    <img src="{{ post.image.url }}" class="img-fluid">
                    {% endif %}

                    <div class="d-flex justify-content-between mt-2">
                        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
                        <button class="btn btn-light" onclick="toggleComments({{ post.id }})">üí¨ <span id="comment-count-{{ post.id }}">{{ post.comments.count }}</span></button>
                        <div>
                            <button class="btn btn-light" onclick="likePost({{ post.id }})">üëç <span id="like-count-{{ post.id }}">{{ post.total_likes }}</span></button>
                            <button class="btn btn-light" onclick="dislikePost({{ post.id }})">üëé <span id="dislike-count-{{ post.id }}">{{ post.total_dislikes }}</span></button>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∞ "–ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ" -->
                        <a href="{% url 'post_detail' post.id %}" class="text-primary">–ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ</a>
                    </div>
                </div>

                <!-- –°–µ–∫—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞) -->
                <div id="comments-section-{{ post.id }}" class="d-none p-3">
                    <h6><span id="comment-header-{{ post.id }}">{{ post.comments.count }}</span> –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</h6>

                    <textarea id="comment-input-{{ post.id }}" class="form-control my-2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
                    <button class="btn btn-dark" onclick="addComment({{ post.id }})">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

                    <div id="comments-list-{{ post.id }}">
                        {% for comment in post.comments.all %}
                        <div class="card mt-2 p-2">
                            <div class="d-flex align-items-center">
                                <img src="{{ comment.author.profile.avatar.url }}" class="rounded-circle me-2" width="30">
                                <a href="{% url 'profile' comment.author.username %}" class="text-dark"><strong>{{ comment.author.username }}</strong></a>
                            </div>
                            <p class="mt-1">{{ comment.content }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}

        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞ -->
    <div id="createPostModal" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex justify-content-center align-items-center">
        <div class="bg-white p-4 rounded" style="width: 500px;">
            <h4>–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</h4>
            <form id="postForm" onsubmit="submitPost(event)">
                {% csrf_token %}
                <input type="text" class="form-control my-2" name="title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" required>
                <textarea class="form-control my-2" name="content" placeholder="–¢–µ–∫—Å—Ç" rows="4" required></textarea>
                <input type="file" class="form-control my-2" name="image">
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" onclick="closeCreatePostModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-dark">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    function toggleFollow(username) {
        fetch(`/profile/${username}/follow/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": document.querySelector("input[name=csrfmiddlewaretoken]").value,
                "Content-Type": "application/json"
            }
        })
        .then(response => response.json())
        .then(data => {
            let followBtn = document.getElementById(`follow-btn-${username}`) || document.getElementById("follow-btn");

            if (data.following) {
                followBtn.innerText = "–ü–æ–¥–ø–∏—Å–∞–Ω–æ";
                followBtn.classList.remove("btn-dark");
                followBtn.classList.add("btn-outline-dark");
            } else {
                followBtn.innerText = "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è";
                followBtn.classList.remove("btn-outline-dark");
                followBtn.classList.add("btn-dark");
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            let followerCount = document.getElementById("follower-count");
            if (followerCount) {
                followerCount.innerText = data.followers_count;
            }
        })
        .catch(error => console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏:", error));
    }
    </script>

</body>
</html>
